server_tokens off;
# when modsecurity can be compiled right, add these back
# load_module modules/ngx_http_modsecurity_module.so;
# modsecurity on;
# modsecurity_rules_file /etc/nginx/modsec/main.conf;
server {
  listen [::]:443 ssl ipv6only=on;
  listen 443 ssl;
  server_name perdido.bond;
  include /etc/nginx/fragments/perdido.bond.ssl.conf;
  client_max_body_size 20M;
  location ~* ^/(robots.txt|index.html)?$ {
    root /var/www/perdido.bond;
    index index.html;
  }

  location /jellyfin/ {
      include /etc/nginx/fragments/auth.conf;
      proxy_pass http://localhost:8096;
      include /etc/nginx/fragments/proxy-headers.conf;
  }

  location /files/ {
      include /etc/nginx/fragments/auth.conf;
      proxy_pass http://localhost:7567;
      include /etc/nginx/fragments/proxy-headers.conf;
  }

  location /rutorrent/ {
    include /etc/nginx/fragments/auth.conf;
    index index.html;
    location ~ .php {
        fastcgi_split_path_info ^(.+\.php)(.*)$;
        fastcgi_pass unix:/run/php/php7.4-fpm.sock;
        include fastcgi_params;
        fastcgi_index   index.php;
        fastcgi_param   SCRIPT_FILENAME /var/www/perdido.bond$fastcgi_script_name;
    }
    location /rutorrent/ {
      root /var/www/perdido.bond/;
      try_files $uri =404;
    }
  }

  location ~ /RPC2 {
    include /etc/nginx/fragments/auth.conf;
    access_log /var/log/nginx/scgi.log;
    error_log /var/log/nginx/scgi.log;
    include scgi_params;
    scgi_pass unix:/var/rtorrent/session/scgi.socket;
  }

  rewrite ^/(rutorrent)/?$ /$1/index.html permanent;
}

server {
  listen 80 default_server;
  listen [::]:80 default_server;
  server_name localhost perdido.bond 127.0.0.1;
  return 301 https://perdido.bond$request_uri;
}


